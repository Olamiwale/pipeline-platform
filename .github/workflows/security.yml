# Github Actions security workflow

name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *'  # Daily

jobs:
    secret-scan:
        runs-on: [self-hosted, kubernetes]
        steps:
        - uses: actions/checkout@v3
          with:
            fetch-depth: 0
        
        - name: TruffleHog Secret Scan
          uses: trufflesecurity/trufflehog@main
          with:
            path: ./
            base: ${{ github.event.repository.default_branch }}
            head: HEAD

    sast:
        runs-on: [self-hosted, kubernetes]
        steps:
        - uses: actions/checkout@v3
        - name: Run Semgrep
          uses: returntocorp/semgrep-action@v1
          with:
            config: auto

    dependency-check:
        runs-on: [self-hosted, kubernetes]
        steps:
        - uses: actions/checkout@v3

        - name: OWASP Dependency-Check
          uses: dependency-check/github-action@v2
          with:
            project: sample-app
            path: ./
            format: 'ALL'

        - name: Upload results
          uses: actions/upload-artifact@v3
          with:
            name: dependency-check-report
            path: reports/

    container-scan:
        runs-on: [self-hosted, kubernetes]  
        needs: build
        steps:
        - name: Run Trivy
          uses: aquasecurity/trivy-action@master
          with:
            image-ref: registry.local:5000/app:latest
            format: 'sarif'
            exit-code: '1'
            severity: 'HIGH,CRITICAL'
            ignore-unfixed: 'true'
            vuln-type: 'os,library'

        
        - name: Upload to GitHub Security
          uses: github/codeql-action/upload-sarif@v2
          with:
            sarif-file: trivy-results.sarif



    k8s-deployment-scan:
        runs-on: [self-hosted, kubernetes]
        steps:
        - uses: actions/checkout@v3

        - name: Scan Kubernetes manifests
          uses: aquasecurity/trivy-action@master
          with:
            scan-type: 'config'
            scan-ref: './k8s'
            format: 'sarif'
            output: 'k8s-scan-results.sarif'
            exit-code: '1'


        - name: Upload results
          uses: github/codeql-action/upload-sarif@v2
          with:
            sarif_file: 'k8s-scan-results.sarif'

